@using Microsoft.AspNetCore.Components.Authorization
@using WebApp.Services
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<nav class="navbar font-title">
    <div class="navbar-container">
        <a href="/" class="navbar-brand">
            <img src="/images/logo.png" 
                 alt="University Logo" 
                 class="navbar-logo" 
                 onerror="this.style.display='none'" />
            <div class="navbar-title">
                <h1>APPLICATION PORTAL</h1>
                <div class="flex">
                    <small class="pr-1">Powered by</small><p>CSE Department</p>
                </div>
            </div>
        </a>

        <div class="navbar-menu">
            <a href="/my-applications" class="nav-link">Track</a>
            <a href="/forms" class="nav-link">Download Forms</a>
            <a href="/contact" class="nav-link">Contact</a>
            
            @if (_isLoading)
            {
                <div class="skeleton-button"></div>
            }
            else if (_currentUser != null)
            {
                <div class="profile-dropdown">
                    <button @onclick="ToggleProfileMenu" 
                            class="profile-button"
                            aria-label="User menu"
                            aria-expanded="@_showProfileMenu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </button>
                    
                    @if (_showProfileMenu)
                    {
                        <div class="dropdown-menu" @onclick:stopPropagation>
                            <div class="dropdown-header">
                                <p class="dropdown-role">@_currentUser.Role</p>
                                <p class="dropdown-email">@_currentUser.Email</p>
                            </div>
                            <div class="dropdown-body">
                                <button @onclick="NavigateToDashboard" class="dropdown-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                                    <span>Dashboard</span>
                                </button>
                                <button @onclick="HandleLogout" class="dropdown-item dropdown-item-danger" disabled="@_isLoggingOut">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                                    <span>@(_isLoggingOut ? "Logging out..." : "Logout")</span>
                                </button>
                            </div>
                        </div>
                        <div class="dropdown-backdrop" @onclick="CloseProfileMenu"></div>
                    }
                </div>
            }
            else
            {
                <button @onclick="NavigateToLogin" class="btn-login">Login</button>
            }
        </div>

        <button @onclick="ToggleMobileMenu" 
                class="mobile-menu-button"
                aria-label="Menu"
                aria-expanded="@_showMobileMenu">
            <span class="hamburger-line" style="@(_showMobileMenu ? "transform: rotate(45deg) translateY(9px);" : "")"></span>
            <span class="hamburger-line" style="@(_showMobileMenu ? "opacity: 0;" : "")"></span>
            <span class="hamburger-line" style="@(_showMobileMenu ? "transform: rotate(-45deg) translateY(-9px);" : "")"></span>
        </button>
    </div>
</nav>

@if (_showMobileMenu)
{
    <div class="mobile-overlay" @onclick="CloseMobileMenu"></div>
    <div class="mobile-drawer" @onclick:stopPropagation>
        @if (_currentUser != null)
        {
            <div class="mobile-header">
                <div class="mobile-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
                <div>
                    <p class="mobile-role">@_currentUser.Role</p>
                    <p class="mobile-email">@_currentUser.Email</p>
                </div>
            </div>
        }

        <nav class="mobile-nav">
            <a href="/my-applications" @onclick="CloseMobileMenu" class="mobile-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span>Track</span>
            </a>
            <a href="/forms" @onclick="CloseMobileMenu" class="mobile-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                <span>Download Forms</span>
            </a>
            <a href="/contact" @onclick="CloseMobileMenu" class="mobile-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                <span>Contact</span>
            </a>

            @if (_currentUser != null)
            {
                <div class="mobile-divider"></div>
                <a href="/dashboard" @onclick="CloseMobileMenu" class="mobile-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                    <span>Dashboard</span>
                </a>
                <button @onclick="HandleLogout" class="mobile-link mobile-link-danger" disabled="@_isLoggingOut">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>@(_isLoggingOut ? "Logging out..." : "Logout")</span>
                </button>
            }
            else
            {
                <button @onclick="NavigateToLogin" class="mobile-link-login">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                    <span>Login</span>
                </button>
            }
        </nav>
    </div>
}

@code {
    private UserInfo? _currentUser;
    private bool _isLoading = true;
    private bool _showMobileMenu;
    private bool _showProfileMenu;
    private bool _isLoggingOut;

    protected override async Task OnInitializedAsync()
    {
        if (AuthStateProvider is AppAuthStateProvider provider)
        {
            provider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        }
        await LoadUserAsync();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await LoadUserAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadUserAsync()
    {
        _isLoading = true;
        _currentUser = await AuthService.GetCurrentUserAsync();
        _isLoading = false;
    }

    private async Task ToggleMobileMenu()
    {
        _showMobileMenu = !_showMobileMenu;
        _showProfileMenu = false;
        await ToggleBodyScroll(_showMobileMenu);
    }

    private async Task CloseMobileMenu()
    {
        _showMobileMenu = false;
        await ToggleBodyScroll(false);
    }

    private void ToggleProfileMenu()
    {
        _showProfileMenu = !_showProfileMenu;
    }

    private void CloseProfileMenu()
    {
        _showProfileMenu = false;
    }

    private void NavigateToLogin()
    {
        _showMobileMenu = false;
        Navigation.NavigateTo("/login");
    }

    private void NavigateToDashboard()
    {
        _showProfileMenu = false;
        _showMobileMenu = false;
        if(_currentUser != null && _currentUser.Role == "Admin")
            Navigation.NavigateTo("/admin");
        else
        Navigation.NavigateTo("/dashboard");
    }

    private async Task HandleLogout()
    {
        if (_isLoggingOut) return;

        try
        {
            _isLoggingOut = true;
            StateHasChanged();

            await AuthService.LogoutAsync();
            
            _currentUser = null;
            _showProfileMenu = false;
            _showMobileMenu = false;

            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Logout failed: {ex.Message}");
        }
        finally
        {
            _isLoggingOut = false;
        }
    }

    private async Task ToggleBodyScroll(bool disable)
    {
        try
        {
            if (disable)
            {
                await JSRuntime.InvokeVoidAsync("eval", @"
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                ");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("eval", @"
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                ");
            }
        }
        catch
        {
            
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (AuthStateProvider is AppAuthStateProvider provider)
        {
            provider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        }

        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            ");
        }
        catch
        {
           
        }
    }
}
