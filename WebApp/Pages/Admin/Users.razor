@page "/admin/users"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject IToastService ToastService

<PageTitle>Users - Admin Panel</PageTitle>

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">User Management</h1>
        <button @onclick="LoadUsers"
                class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition">
            Refresh
        </button>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <div class="relative">
                    <input type="text" @bind="_searchTerm" @bind:event="oninput" 
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Search by name, email, department..." />
                    <svg class="absolute left-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                <select @bind="_selectedRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Roles</option>
                    <option value="Applicant">Applicant</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select @bind="_selectedStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Disabled">Disabled</option>
                </select>
            </div>
        </div>

        <div class="mb-4 flex items-center justify-between">
            <p class="text-sm text-gray-600">
                Showing <span class="font-semibold">@FilteredAndSortedUsers.Count</span> of <span class="font-semibold">@_users.Count</span> users
            </p>
            @if (!string.IsNullOrWhiteSpace(_searchTerm) || !string.IsNullOrWhiteSpace(_selectedStatus) || !string.IsNullOrWhiteSpace(_selectedRole))
            {
                <button @onclick="ClearFilters" class="text-sm text-blue-600 hover:text-blue-800">
                    Clear Filters
                </button>
            }
        </div>

        @if (isLoading)
        {
            <div class="py-10 text-center text-gray-500">Loading users...</div>
        }
        else if (!string.IsNullOrWhiteSpace(loadError))
        {
            <div class="py-10 text-center text-red-600">@loadError</div>
        }
        else
        {
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Session</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @if (FilteredAndSortedUsers.Count == 0)
                        {
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                    No users found matching your criteria.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var user in FilteredAndSortedUsers)
                            {
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">@user.Username</td>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">@user.Name</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">@user.Email</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">@user.Department</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">@user.Session</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">@user.Role</td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="inline-flex px-2 py-1 text-xs leading-5 font-semibold rounded-full
                                                       @(user.Status == "Active" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")">
                                            @user.Status
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-500">
                                        @user.CreatedAt.ToString("dd MMM yyyy")
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <button class="text-blue-600 hover:text-blue-800 mr-3"
                                                @onclick="() => ShowDetails(user.Id)">
                                            View
                                        </button>
                                        <button class="text-red-600 hover:text-red-800"
                                                disabled="@IsStatusUpdating(user.Id)"
                                                @onclick="() => ToggleStatus(user.Id, user.Status)">
                                            @(user.Status == "Active" ? "Deactivate" : "Activate")
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@if (showDetails && selectedUser != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-900">User Details</h2>
                <button class="text-gray-500 hover:text-gray-900" @onclick="CloseDetails">âœ•</button>
            </div>

            @if (detailsLoading)
            {
                <div class="py-10 text-center text-gray-500">Loading details...</div>
            }
            else
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Name</p>
                        <p class="font-medium text-gray-900">@selectedUser.Name</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Username</p>
                        <p class="font-medium text-gray-900">@selectedUser.Username</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Email</p>
                        <p class="font-medium text-gray-900">@selectedUser.Email</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Role</p>
                        <p class="font-medium text-gray-900">@selectedUser.Role</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Status</p>
                        <p class="font-medium text-gray-900">@selectedUser.Status</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Phone</p>
                        <p class="font-medium text-gray-900">@selectedUser.Phone</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Department</p>
                        <p class="font-medium text-gray-900">@selectedUser.Department</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Session</p>
                        <p class="font-medium text-gray-900">@selectedUser.Session</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Year</p>
                        <p class="font-medium text-gray-900">@selectedUser.Year</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Semester</p>
                        <p class="font-medium text-gray-900">@selectedUser.Semester</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Faculty</p>
                        <p class="font-medium text-gray-900">@selectedUser.Faculty</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Permanent Address</p>
                        <p class="font-medium text-gray-900">@selectedUser.PermanentAddress</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase">Current Address</p>
                        <p class="font-medium text-gray-900">@selectedUser.CurrentAddress</p>
                    </div>
                </div>

                <div class="mt-6 flex items-center justify-end gap-2">
                    <button class="px-4 py-2 rounded-lg border text-gray-700" @onclick="CloseDetails">Close</button>
                    <button class="px-4 py-2 rounded-lg bg-gray-900 text-white"
                            disabled="@IsStatusUpdating(selectedUser.Id)"
                            @onclick="() => ToggleStatus(selectedUser.Id, selectedUser.Status)">
                        @(selectedUser.Status == "Active" ? "Deactivate User" : "Activate User")
                    </button>
                </div>
            }
        </div>
    </div>
}

@code {
    private List<UserRow> _users = new();
    private string _searchTerm = string.Empty;
    private string _selectedStatus = string.Empty;
    private string _selectedRole = string.Empty;
    private bool isLoading = true;
    private string? loadError;
    private bool showDetails;
    private bool detailsLoading;
    private UserDetailsDto? selectedUser;
    private readonly HashSet<long> statusUpdatingIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            isLoading = true;
            loadError = null;
            _users = await Http.GetFromJsonAsync<List<UserRow>>("api/users") ?? new();
        }
        catch
        {
            loadError = "Failed to load users.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private List<UserRow> FilteredAndSortedUsers
    {
        get
        {
            var filtered = _users.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                filtered = filtered.Where(u =>
                    u.Name.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    u.Email.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    u.Username.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (u.Department ?? string.Empty).Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            if (!string.IsNullOrWhiteSpace(_selectedStatus))
            {
                filtered = filtered.Where(u => u.Status == _selectedStatus);
            }

            if (!string.IsNullOrWhiteSpace(_selectedRole))
            {
                filtered = filtered.Where(u => u.Role == _selectedRole);
            }

            return filtered
                .OrderBy(u => u.Name)
                .ThenBy(u => u.Username)
                .ToList();
        }
    }

    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _selectedStatus = string.Empty;
        _selectedRole = string.Empty;
    }

    private async Task ShowDetails(long userId)
    {
        try
        {
            showDetails = true;
            detailsLoading = true;
            selectedUser = await Http.GetFromJsonAsync<UserDetailsDto>($"api/users/{userId}");
        }
        catch
        {
            ToastService.ShowError("Failed to load user details");
        }
        finally
        {
            detailsLoading = false;
        }
    }

    private void CloseDetails()
    {
        showDetails = false;
        selectedUser = null;
    }

    private async Task ToggleStatus(long userId, string currentStatus)
    {
        if (IsStatusUpdating(userId))
            return;

        var newStatus = currentStatus == "Active" ? "Disabled" : "Active";
        statusUpdatingIds.Add(userId);

        try
        {
            var response = await Http.PutAsJsonAsync($"api/users/{userId}/status", new { Status = newStatus });
            if (response.IsSuccessStatusCode)
            {
                var row = _users.FirstOrDefault(u => u.Id == userId);
                if (row != null)
                {
                    row.Status = newStatus;
                }
                if (selectedUser?.Id == userId)
                {
                    selectedUser.Status = newStatus;
                }
                ToastService.ShowSuccess("User status updated");
            }
            else
            {
                ToastService.ShowError("Failed to update status");
            }
        }
        catch
        {
            ToastService.ShowError("Failed to update status");
        }
        finally
        {
            statusUpdatingIds.Remove(userId);
        }
    }

    private bool IsStatusUpdating(long userId) => statusUpdatingIds.Contains(userId);

    public class UserRow
    {
        public long Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? Department { get; set; }
        public string? Session { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class UserDetailsDto
    {
        public long Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? Phone { get; set; }
        public string? Department { get; set; }
        public string? Session { get; set; }
        public string? Year { get; set; }
        public string? Semester { get; set; }
        public string? Faculty { get; set; }
        public string? PermanentAddress { get; set; }
        public string? CurrentAddress { get; set; }
    }
}
