@page "/admin/equipment/create"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>Add Equipment - Admin Panel</PageTitle>

<div class="max-w-3xl mx-auto p-3 md:p-5">
    <div class="mb-5">
        <button class="flex items-center gap-1.5 px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 mb-2" @onclick="NavigateBack">
            <span>←</span>
            <span>Back</span>
        </button>
        <h1 class="text-2xl md:text-3xl font-bold font-title text-gray-900">Add New Equipment</h1>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:p-6">
        <EditForm Model="model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1.5">Equipment Name *</label>
                    <InputText id="name" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                              @bind-Value="model.Name" 
                              placeholder="e.g., Desktop Computer - Lab 301" />
                    <ValidationMessage For="@(() => model.Name)" class="text-xs text-red-600 mt-1" />
                </div>

                <div>
                    <label for="code" class="block text-sm font-medium text-gray-700 mb-1.5">Equipment Code *</label>
                    <InputText id="code" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                              @bind-Value="model.EquipmentCode" 
                              placeholder="e.g., COMP-2024-001 (uppercase, numbers, hyphens only)" />
                    <ValidationMessage For="@(() => model.EquipmentCode)" class="text-xs text-red-600 mt-1" />
                    <p class="text-xs text-gray-500 mt-1">Must be unique. Use uppercase letters, numbers, and hyphens/underscores.</p>
                </div>

                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1.5">Category *</label>
                    <InputText id="category" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                              @bind-Value="model.Category" 
                              placeholder="e.g., Computer, Projector, Camera" />
                    <ValidationMessage For="@(() => model.Category)" class="text-xs text-red-600 mt-1" />
                </div>

                <div>
                    <label for="condition" class="block text-sm font-medium text-gray-700 mb-1.5">Condition *</label>
                    <InputSelect id="condition" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                @bind-Value="model.Condition">
                        <option value="0">Good</option>
                        <option value="1">Fair</option>
                        <option value="2">Damaged</option>
                        <option value="3">Under Maintenance</option>
                        <option value="4">Retired</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => model.Condition)" class="text-xs text-red-600 mt-1" />
                    <p class="text-xs text-gray-500 mt-1">Physical condition of the equipment</p>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1.5">Description</label>
                    <InputTextArea id="description" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow resize-none" 
                                  @bind-Value="model.Description" 
                                  rows="4"
                                  placeholder="e.g., Dell OptiPlex 7080, Intel i7, 16GB RAM, 512GB SSD, Serial: ABC123XYZ" />
                    <ValidationMessage For="@(() => model.Description)" class="text-xs text-red-600 mt-1" />
                    <p class="text-xs text-gray-500 mt-1">Optional. Add detailed specifications, serial number, or any notes.</p>
                </div>
            </div>

            @if (errorMessage != null)
            {
                <div class="flex items-start gap-2 p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg mt-4 text-sm">
                    <span class="text-lg">⚠</span>
                    <div class="flex-1">
                        <p class="font-medium mb-0.5">Failed to create equipment</p>
                        <p class="text-xs">@errorMessage</p>
                    </div>
                    <button type="button" class="text-red-600 hover:text-red-800" @onclick="@(() => errorMessage = null)">✕</button>
                </div>
            }

            <div class="flex justify-end gap-3 pt-6 mt-6 border-t border-gray-200">
                <button type="button" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors" @onclick="NavigateBack">
                    Cancel
                </button>
                <SubmitButton 
                    ButtonText="Add Equipment"
                    ProcessingText="Creating..."
                    IsProcessing="@isSubmitting"
                    OnClick="HandleSubmit" />
            </div>
        </EditForm>
    </div>
</div>

@code {
    private CreateEquipmentModel model = new();
    private bool isSubmitting = false;
    private string? errorMessage;

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;

            var response = await Http.PostAsJsonAsync("api/equipment", new
            {
                Name = model.Name,
                EquipmentCode = model.EquipmentCode,
                Category = model.Category,
								Condition = model.Condition,
                Description = string.IsNullOrWhiteSpace(model.Description) ? null : model.Description
            });

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowSuccess($"Equipment '{model.Name}' created successfully!");
                await Task.Delay(800);
                Navigation.NavigateTo("/admin/equipment");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Server error: {errorContent}";
                ToastService.ShowError("Failed to create equipment");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void NavigateBack() => Navigation.NavigateTo("/admin/equipment");

    public class CreateEquipmentModel
    {
        [Required(ErrorMessage = "Equipment name is required")]
        [StringLength(255, ErrorMessage = "Name must not exceed 255 characters")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Equipment code is required")]
        [StringLength(100, ErrorMessage = "Code must not exceed 100 characters")]
        [RegularExpression(@"^[A-Z0-9\-_]+$", ErrorMessage = "Code must only contain uppercase letters, numbers, hyphens, and underscores")]
        public string EquipmentCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "Category is required")]
        [StringLength(100, ErrorMessage = "Category must not exceed 100 characters")]
        public string Category { get; set; } = string.Empty;

        [Required(ErrorMessage = "Condition is required")]
        public int Condition { get; set; } = 0;

        [StringLength(1000, ErrorMessage = "Description must not exceed 1000 characters")]
        public string? Description { get; set; }
    }
}
