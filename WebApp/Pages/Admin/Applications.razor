@page "/admin/applications"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Applications - Admin Panel</PageTitle>

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">Applications Management</h1>
        <div class="flex gap-3">
            <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                Export to Excel
            </button>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <!-- Search and Filter Section -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Search Bar -->
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <div class="relative">
                    <input type="text" @bind="_searchTerm" @bind:event="oninput" 
                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Search by student name, ID, service..." />
                    <svg class="absolute left-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- Service Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Service</label>
                <select @bind="_selectedService" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Services</option>
                    <option value="Transcript Request">Transcript Request</option>
                    <option value="Certificate Request">Certificate Request</option>
                    <option value="Equipment Borrowing">Equipment Borrowing</option>
                </select>
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select @bind="_selectedStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>

            <!-- Sort By -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                <select @bind="_sortBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="date">Latest First</option>
                    <option value="dateOld">Oldest First</option>
                    <option value="student">Student Name</option>
                    <option value="service">Service Name</option>
                    <option value="status">Status</option>
                </select>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-xs text-yellow-600 font-medium">Pending</p>
                <p class="text-2xl font-bold text-yellow-900">@_applications.Count(a => a.Status == "Pending")</p>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p class="text-xs text-blue-600 font-medium">In Progress</p>
                <p class="text-2xl font-bold text-blue-900">@_applications.Count(a => a.Status == "In Progress")</p>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <p class="text-xs text-green-600 font-medium">Approved</p>
                <p class="text-2xl font-bold text-green-900">@_applications.Count(a => a.Status == "Approved")</p>
            </div>
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <p class="text-xs text-purple-600 font-medium">Completed</p>
                <p class="text-2xl font-bold text-purple-900">@_applications.Count(a => a.Status == "Completed")</p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-xs text-red-600 font-medium">Rejected</p>
                <p class="text-2xl font-bold text-red-900">@_applications.Count(a => a.Status == "Rejected")</p>
            </div>
        </div>

        <!-- Results Count -->
        <div class="mb-4 flex items-center justify-between">
            <p class="text-sm text-gray-600">
                Showing <span class="font-semibold">@FilteredAndSortedApplications.Count</span> of <span class="font-semibold">@_applications.Count</span> applications
            </p>
            @if (!string.IsNullOrWhiteSpace(_searchTerm) || !string.IsNullOrWhiteSpace(_selectedService) || !string.IsNullOrWhiteSpace(_selectedStatus))
            {
                <button @onclick="ClearFilters" class="text-sm text-blue-600 hover:text-blue-800">
                    Clear Filters
                </button>
            }
        </div>

        <!-- Applications Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            App ID
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Student ID
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Student Name
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Service
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Current Step
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Applied Date
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @if (FilteredAndSortedApplications.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                No applications found matching your criteria.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var app in FilteredAndSortedApplications)
                        {
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">#@app.Id</td>
                                <td class="px-4 py-3 text-sm text-gray-500">@app.StudentId</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">@app.StudentName</td>
                                <td class="px-4 py-3 text-sm text-gray-900">@app.ServiceName</td>
                                <td class="px-4 py-3 text-sm text-gray-600">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-semibold">
                                            @app.CurrentStep
                                        </div>
                                        <span class="text-xs">@app.CurrentStepName</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <span class="inline-flex px-2 py-1 text-xs leading-5 font-semibold rounded-full
                                                   @(app.Status == "Pending" ? "bg-yellow-100 text-yellow-800" :
                                                     app.Status == "In Progress" ? "bg-blue-100 text-blue-800" :
                                                     app.Status == "Approved" ? "bg-green-100 text-green-800" :
                                                     app.Status == "Completed" ? "bg-purple-100 text-purple-800" :
                                                     "bg-red-100 text-red-800")">
                                        @app.Status
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500">
                                    @app.CreatedAt.ToString("dd MMM yyyy")
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <button class="text-blue-600 hover:text-blue-800 mr-3">View</button>
                                    <button class="text-green-600 hover:text-green-800 mr-3">Process</button>
                                    <button class="text-red-600 hover:text-red-800">Reject</button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    public class ApplicationRow
    {
        public int Id { get; set; }
        public string StudentId { get; set; } = default!;
        public string StudentName { get; set; } = default!;
        public string ServiceName { get; set; } = default!;
        public int CurrentStep { get; set; }
        public string CurrentStepName { get; set; } = default!;
        public string Status { get; set; } = default!;
        public DateTime CreatedAt { get; set; }
    }

    private List<ApplicationRow> _applications = new()
    {
        new ApplicationRow 
        { 
            Id = 1001, 
            StudentId = "200101",
            StudentName = "Md. Mamun-Or-Rashid", 
            ServiceName = "Transcript Request",
            CurrentStep = 2,
            CurrentStepName = "Payment",
            Status = "In Progress",
            CreatedAt = DateTime.Now.AddDays(-2)
        },
        new ApplicationRow 
        { 
            Id = 1002, 
            StudentId = "200102",
            StudentName = "Ahmed Khan", 
            ServiceName = "Certificate Request",
            CurrentStep = 1,
            CurrentStepName = "Fill Application",
            Status = "Pending",
            CreatedAt = DateTime.Now.AddDays(-1)
        },
        new ApplicationRow 
        { 
            Id = 1003, 
            StudentId = "200103",
            StudentName = "Sarah Ahmed", 
            ServiceName = "Equipment Borrowing",
            CurrentStep = 4,
            CurrentStepName = "Admin Review",
            Status = "Approved",
            CreatedAt = DateTime.Now.AddDays(-5)
        },
        new ApplicationRow 
        { 
            Id = 1004, 
            StudentId = "200104",
            StudentName = "Karim Rahman", 
            ServiceName = "Transcript Request",
            CurrentStep = 5,
            CurrentStepName = "Completed",
            Status = "Completed",
            CreatedAt = DateTime.Now.AddDays(-10)
        },
        new ApplicationRow 
        { 
            Id = 1005, 
            StudentId = "200105",
            StudentName = "Fatima Begum", 
            ServiceName = "Certificate Request",
            CurrentStep = 3,
            CurrentStepName = "Document Upload",
            Status = "Rejected",
            CreatedAt = DateTime.Now.AddDays(-3)
        },
        new ApplicationRow 
        { 
            Id = 1006, 
            StudentId = "200101",
            StudentName = "Md. Mamun-Or-Rashid", 
            ServiceName = "Equipment Borrowing",
            CurrentStep = 1,
            CurrentStepName = "Fill Application",
            Status = "Pending",
            CreatedAt = DateTime.Now.AddHours(-5)
        }
    };

    private string _searchTerm = string.Empty;
    private string _selectedService = string.Empty;
    private string _selectedStatus = string.Empty;
    private string _sortBy = "date";

    private List<ApplicationRow> FilteredAndSortedApplications
    {
        get
        {
            var filtered = _applications.AsEnumerable();

            // Search filter
            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                filtered = filtered.Where(a => 
                    a.StudentName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    a.StudentId.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    a.ServiceName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    a.Id.ToString().Contains(_searchTerm)
                );
            }

            // Service filter
            if (!string.IsNullOrWhiteSpace(_selectedService))
            {
                filtered = filtered.Where(a => a.ServiceName == _selectedService);
            }

            // Status filter
            if (!string.IsNullOrWhiteSpace(_selectedStatus))
            {
                filtered = filtered.Where(a => a.Status == _selectedStatus);
            }

            // Sorting
            filtered = _sortBy switch
            {
                "dateOld" => filtered.OrderBy(a => a.CreatedAt),
                "student" => filtered.OrderBy(a => a.StudentName),
                "service" => filtered.OrderBy(a => a.ServiceName),
                "status" => filtered.OrderBy(a => a.Status),
                _ => filtered.OrderByDescending(a => a.CreatedAt)
            };

            return filtered.ToList();
        }
    }

    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _selectedService = string.Empty;
        _selectedStatus = string.Empty;
        _sortBy = "date";
    }
}
