@page "/admin/applications/{ApplicationId:long}"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>Application #@ApplicationId</PageTitle>

@if (isLoading)
{
    <div class="flex justify-center items-center min-h-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-blue-600"></div>
    </div>
}
else if (application == null)
{
    <div class="max-w-2xl mx-auto px-4 py-16 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Application Not Found</h3>
        <p class="text-sm text-gray-500 mb-4">The application you're looking for doesn't exist or has been removed.</p>
        <button @onclick='() => Navigation.NavigateTo("/admin/applications")' 
                class="px-5 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
            ‚Üê Back to Applications
        </button>
    </div>
}
else
{
    <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 sm:mb-6">
            <div class="flex items-center gap-3">
                <button @onclick='() => Navigation.NavigateTo("/admin/applications")' 
                        class="flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    <span class="hidden sm:inline">Back</span>
                </button>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Application #@application.Id</h1>
                    <p class="text-xs sm:text-sm text-gray-500 mt-0.5">Submitted @application.CreatedAt.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                </div>
            </div>
            <span class="@GetStatusBadge(application.Status) self-start sm:self-auto">@application.Status</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-4 sm:space-y-5">
                <!-- Applicant Information -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <h2 class="text-base sm:text-lg font-bold text-gray-900">Applicant Information</h2>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Full Name</p>
                            <p class="text-sm font-medium text-gray-900">@application.ApplicantName</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Email Address</p>
                            <p class="text-sm font-medium text-gray-900 break-all">@application.ApplicantEmail</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Service Name</p>
                            <p class="text-sm font-medium text-gray-900">@application.ServiceName</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Service Type</p>
                            <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full @GetServiceTypeBadge(application.ServiceType)">
                                @FormatServiceType(application.ServiceType)
                            </span>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Application Date</p>
                            <p class="text-sm font-medium text-gray-900">@application.CreatedAt.ToString("MMM dd, yyyy")</p>
                        </div>
                    </div>

                    @if (application.ScheduledDateTime.HasValue)
                    {
                        <div class="mt-4 p-3 sm:p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-green-800 uppercase tracking-wide mb-1">Appointment Scheduled</p>
                                    <p class="text-sm font-semibold text-green-900">@application.ScheduledDateTime.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                                    <p class="text-xs text-green-700 mt-1">Please arrive 10 minutes early</p>
                                </div>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(application.AdminNotes))
                    {
                        <div class="mt-4 p-3 sm:p-4 bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-yellow-800 uppercase tracking-wide mb-1">Admin Notes</p>
                                    <p class="text-sm text-yellow-900 leading-relaxed">@application.AdminNotes</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Application Steps -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <h2 class="text-base sm:text-lg font-bold text-gray-900">Application Steps</h2>
                    </div>
                    
                    <div class="space-y-4 sm:space-y-5">
                        @foreach (var step in application.Steps.OrderBy(s => s.Order))
                        {
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="flex items-start justify-between gap-3 p-3 sm:p-4 bg-gray-50">
                                    <div class="flex items-start gap-3 flex-1 min-w-0">
                                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm font-bold">
                                            @step.Order
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-sm sm:text-base font-bold text-gray-900 mb-1">@step.Name</h3>
                                            @if (!string.IsNullOrWhiteSpace(step.Instructions))
                                            {
                                                <p class="text-xs sm:text-sm text-gray-600 leading-relaxed">@step.Instructions</p>
                                            }
                                        </div>
                                    </div>
                                    @if (step.RequiresApproval)
                                    {
                                        <span class="flex-shrink-0 text-xs px-2.5 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold whitespace-nowrap">
                                            Needs Approval
                                        </span>
                                    }
                                </div>

                                <div class="p-3 sm:p-4">
                                    @if (step.Submissions.Any())
                                    {
                                        @foreach (var submission in step.Submissions.OrderByDescending(s => s.SubmittedAt))
                                        {
                                            <div class="mb-3 last:mb-0 p-3 sm:p-4 @(submission.IsLatest ? "bg-blue-50 border-2 border-blue-300" : "bg-gray-50 border border-gray-200") rounded-lg">
                                                <div class="flex flex-wrap items-center gap-2 mb-3">
                                                    <span class="@GetSubmissionStatusBadge(submission.Status)">
                                                        @GetStatusIcon(submission.Status) @submission.Status
                                                    </span>
                                                    @if (submission.IsLatest)
                                                    {
                                                        <span class="text-xs px-2 py-1 bg-blue-600 text-white rounded-full font-semibold">Latest Submission</span>
                                                    }
                                                    <span class="ml-auto text-xs text-gray-500 font-medium">@submission.SubmittedAt.ToString("MMM dd, yyyy 'at' hh:mm tt")</span>
                                                </div>

                                                @if (!string.IsNullOrWhiteSpace(submission.FormData))
                                                {
                                                    <div class="mb-3">
                                                        <p class="text-xs font-bold text-gray-700 uppercase tracking-wide mb-2">Applicant Response:</p>
                                                        <div class="p-3 bg-white border border-gray-200 rounded-lg">
                                                            <p class="text-sm text-gray-900 leading-relaxed whitespace-pre-wrap">@submission.FormData</p>
                                                        </div>
                                                    </div>
                                                }

                                                @if (submission.Documents.Any())
                                                {
                                                    <div class="mb-3">
                                                        <p class="text-xs font-bold text-gray-700 uppercase tracking-wide mb-2">
                                                            üìé Attached Documents (@submission.Documents.Count)
                                                        </p>
                                                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3">
                                                            @foreach (var doc in submission.Documents)
                                                            {
                                                                <div class="group relative border-2 border-gray-200 rounded-lg overflow-hidden hover:border-blue-500 transition cursor-pointer"
                                                                     @onclick="() => OpenDocumentModal(doc)">
                                                                    @if (IsImage(doc.FileName))
                                                                    {
                                                                        <div class="aspect-square">
                                                                            <img src="@GetDocumentUrl(doc.FilePath)" 
                                                                                 alt="@doc.FileName" 
                                                                                 class="w-full h-full object-cover group-hover:scale-105 transition" />
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <div class="aspect-square flex flex-col items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 p-3">
                                                                            <svg class="w-10 h-10 text-gray-400 mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                                                <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                                                                            </svg>
                                                                            <p class="text-xs text-gray-500 font-medium">@GetFileExtension(doc.FileName)</p>
                                                                        </div>
                                                                    }
                                                                    <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                                                                        <p class="text-xs text-white font-medium truncate">@doc.FileName</p>
                                                                    </div>
                                                                    <div class="absolute inset-0 bg-blue-600/0 group-hover:bg-blue-600/10 transition flex items-center justify-center">
                                                                        <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                                                        </svg>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                }

                                                @if (!string.IsNullOrWhiteSpace(submission.RejectionReason))
                                                {
                                                    <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded">
                                                        <div class="flex items-start gap-2">
                                                            <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                            </svg>
                                                            <div>
                                                                <p class="text-xs font-bold text-red-800 mb-1">Rejection Reason:</p>
                                                                <p class="text-sm text-red-900">@submission.RejectionReason</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }

                                                @if (submission.IsLatest && submission.Status == "Pending" && step.RequiresApproval)
                                                {
                                                    <div class="grid grid-cols-2 gap-2 sm:gap-3 mt-3 pt-3 border-t border-gray-200">
                                                        <button @onclick="() => ShowApproveModal(submission.Id)" 
                                                                class="px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                            </svg>
                                                            Approve
                                                        </button>
                                                        <button @onclick="() => ShowRejectModal(submission.Id)" 
                                                                class="px-4 py-2.5 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2">
                                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                            </svg>
                                                            Reject
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center py-8">
                                            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            <p class="text-sm text-gray-500 font-medium">No submissions yet</p>
                                            <p class="text-xs text-gray-400 mt-1">Waiting for applicant to submit this step</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-4 lg:sticky lg:top-4 lg:self-start">
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <h2 class="text-base font-bold text-gray-900">Quick Actions</h2>
                    </div>
                    
                    @if (CanScheduleAppointment())
                    {
                        <button @onclick="ShowScheduleModal" 
                                class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg text-sm font-semibold hover:from-blue-700 hover:to-blue-800 transition mb-2 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            Schedule Appointment
                        </button>
                    }

                    @if (application.ServiceType == "EquipmentLoan" && CanAssignEquipment())
                    {
                        <button @onclick="ShowAssignEquipmentModal" 
                                class="w-full px-4 py-3 bg-gradient-to-r from-orange-600 to-orange-700 text-white rounded-lg text-sm font-semibold hover:from-orange-700 hover:to-orange-800 transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Assign Equipment
                        </button>
                    }

                    @if (!CanScheduleAppointment() && !CanAssignEquipment())
                    {
                        <div class="text-center py-6">
                            <svg class="w-10 h-10 text-gray-300 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-xs text-gray-500">No actions available</p>
                        </div>
                    }
                </div>

                <!-- Equipment Assignments -->
                @if (application.EquipmentAssignments.Any())
                {
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            </svg>
                            <h2 class="text-base font-bold text-gray-900">Equipment</h2>
                        </div>
                        @foreach (var assignment in application.EquipmentAssignments)
                        {
                            <div class="p-3 bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-lg mb-3 last:mb-0">
                                <div class="flex items-start justify-between gap-2 mb-2">
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-bold text-gray-900 truncate">@assignment.EquipmentName</p>
                                        <p class="text-xs text-gray-600 font-medium">Code: @assignment.EquipmentCode</p>
                                    </div>
                                    <span class="flex-shrink-0 text-xs px-2 py-1 rounded-full bg-orange-200 text-orange-800 font-semibold">
                                        @assignment.Status
                                    </span>
                                </div>
                                <div class="flex items-center gap-1 text-xs text-gray-600 mb-1">
                                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    Assigned: @assignment.AssignedAt.ToString("MMM dd, yyyy")
                                </div>
                                @if (assignment.ExpectedReturnDate.HasValue)
                                {
                                    <div class="flex items-center gap-1 text-xs text-gray-600">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Return: @assignment.ExpectedReturnDate.Value.ToString("MMM dd, yyyy")
                                    </div>
                                }

                                @if (assignment.Status == "ReturnRequested" || assignment.Status == "DamageDisputed")
                                {
                                    if (!assignmentActionNotes.ContainsKey(assignment.Id))
                                    {
                                        assignmentActionNotes[assignment.Id] = string.Empty;
                                    }

                                    <div class="mt-3">
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Admin Notes</label>
                                        <textarea rows="2"
                                                  @bind="assignmentActionNotes[assignment.Id]"
                                                  class="w-full px-2 py-1.5 border rounded text-xs focus:border-orange-500 focus:outline-none"
                                                  placeholder="Required for damaged/reject/resolve actions"></textarea>
                                    </div>
                                }

                                @if (assignment.Status == "ReturnRequested")
                                {
                                    <div class="mt-3 grid grid-cols-1 gap-1.5">
                                        <button class="px-2 py-1.5 bg-green-600 text-white rounded text-xs font-semibold disabled:opacity-50"
                                                disabled="@IsAssignmentActionLoading(assignment.Id)"
                                                @onclick="@(() => ApproveReturnAsGood(assignment.Id))">
                                            @(IsAssignmentActionLoading(assignment.Id) ? "Processing..." : "Approve Return (Good)")
                                        </button>
                                        <button class="px-2 py-1.5 bg-red-600 text-white rounded text-xs font-semibold disabled:opacity-50"
                                                disabled="@IsAssignmentActionLoading(assignment.Id)"
                                                @onclick="@(() => MarkAssignmentDamaged(assignment.Id))">
                                            @(IsAssignmentActionLoading(assignment.Id) ? "Processing..." : "Mark Damaged")
                                        </button>
                                        <button class="px-2 py-1.5 bg-gray-700 text-white rounded text-xs font-semibold disabled:opacity-50"
                                                disabled="@IsAssignmentActionLoading(assignment.Id)"
                                                @onclick="@(() => RejectAssignmentReturn(assignment.Id))">
                                            @(IsAssignmentActionLoading(assignment.Id) ? "Processing..." : "Reject Return")
                                        </button>
                                    </div>
                                }
                                else if (assignment.Status == "DamageDisputed")
                                {
                                    <div class="mt-3 grid grid-cols-1 gap-1.5">
                                        <button class="px-2 py-1.5 bg-green-700 text-white rounded text-xs font-semibold disabled:opacity-50"
                                                disabled="@IsAssignmentActionLoading(assignment.Id)"
                                                @onclick='() => ResolveAssignment(assignment.Id, "ReturnedGood")'>
                                            @(IsAssignmentActionLoading(assignment.Id) ? "Processing..." : "Resolve as Good")
                                        </button>
                                        <button class="px-2 py-1.5 bg-red-700 text-white rounded text-xs font-semibold disabled:opacity-50"
                                                disabled="@IsAssignmentActionLoading(assignment.Id)"
                                                @onclick='() => ResolveAssignment(assignment.Id, "ReturnedDamaged")'>
                                            @(IsAssignmentActionLoading(assignment.Id) ? "Processing..." : "Resolve as Damaged")
                                        </button>
                                    </div>
                                }
                                else if (assignment.Status == "PendingDamageAcknowledgment")
                                {
                                    <div class="mt-3 text-xs text-red-700 bg-red-50 border border-red-200 rounded p-2">
                                        Waiting for applicant response to damage note.
                                    </div>
                                }
                                else if (assignment.Status == "ReturnRejected")
                                {
                                    <div class="mt-3 text-xs text-gray-600 bg-gray-100 border border-gray-200 rounded p-2">
                                        Return was rejected. Awaiting applicant to request again.
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- Document Preview Modal -->
@if (showDocumentModal && selectedDocument != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4" @onclick="CloseDocumentModal">
        <div class="relative max-w-5xl w-full max-h-[90vh]" @onclick:stopPropagation="true">
            <div class="absolute top-4 right-4 flex gap-2 z-10">
                <a href="@GetDocumentUrl(selectedDocument.FilePath)" 
                   download="@selectedDocument.FileName"
                   target="_blank"
                   class="px-4 py-2 bg-white text-gray-900 rounded-lg text-sm font-semibold hover:bg-gray-100 transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download
                </a>
                <button @onclick="CloseDocumentModal" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 transition">
                    ‚úï Close
                </button>
            </div>
            
            <div class="bg-white rounded-lg overflow-hidden shadow-2xl">
                @if (IsImage(selectedDocument.FileName))
                {
                    <img src="@GetDocumentUrl(selectedDocument.FilePath)" 
                         alt="@selectedDocument.FileName" 
                         class="w-full h-auto max-h-[80vh] object-contain" />
                }
                else
                {
                    <div class="flex flex-col items-center justify-center p-12 bg-gray-50">
                        <svg class="w-20 h-20 text-gray-400 mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                        </svg>
                        <p class="text-lg font-semibold text-gray-900 mb-2">@selectedDocument.FileName</p>
                        <p class="text-sm text-gray-500 mb-4">Preview not available for this file type</p>
                        <a href="@GetDocumentUrl(selectedDocument.FilePath)" 
                           download="@selectedDocument.FileName"
                           target="_blank"
                           class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                            Download File
                        </a>
                    </div>
                }
                <div class="px-4 py-3 bg-gray-50 border-t">
                    <p class="text-sm font-semibold text-gray-900">@selectedDocument.FileName</p>
                </div>
            </div>
        </div>
    </div>
}

<!-- Approve Modal -->
@if (showApproveModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @onclick="CloseModals">
        <div class="bg-white rounded-xl p-5 max-w-md w-full shadow-2xl" @onclick:stopPropagation="true">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Approve Submission</h3>
            </div>
            <p class="text-sm text-gray-600 mb-5 leading-relaxed">
                Are you sure you want to approve this submission? The applicant will be notified and can proceed to the next step.
            </p>
            <div class="flex gap-3">
                <button @onclick="HandleApprove" 
                        disabled="@isProcessing"
                        class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    @(isProcessing ? "Approving..." : "Yes, Approve")
                </button>
                <button @onclick="CloseModals" 
                        disabled="@isProcessing"
                        class="flex-1 px-4 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

<!-- Reject Modal -->
@if (showRejectModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @onclick="CloseModals">
        <div class="bg-white rounded-xl p-5 max-w-md w-full shadow-2xl" @onclick:stopPropagation="true">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Reject Submission</h3>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Rejection Reason *</label>
                <textarea @bind="rejectionReason" 
                          rows="5"
                          class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-red-500 focus:ring-2 focus:ring-red-200 focus:outline-none transition"
                          placeholder="Please provide a clear reason for rejection so the applicant can resubmit correctly..."></textarea>
                <p class="text-xs text-gray-500 mt-1">This message will be visible to the applicant</p>
            </div>
            <div class="flex gap-3">
                <button @onclick="HandleReject" 
                        disabled="@(isProcessing || string.IsNullOrWhiteSpace(rejectionReason))"
                        class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    @(isProcessing ? "Rejecting..." : "Reject Submission")
                </button>
                <button @onclick="CloseModals" 
                        disabled="@isProcessing"
                        class="flex-1 px-4 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

<!-- Schedule Modal -->
@if (showScheduleModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @onclick="CloseModals">
        <div class="bg-white rounded-xl p-5 max-w-md w-full shadow-2xl" @onclick:stopPropagation="true">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Schedule Appointment</h3>
            </div>
            <div class="space-y-4 mb-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date & Time *</label>
                    <input type="datetime-local" 
                           @bind="scheduledDateTime"
                           min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                           class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition" />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Additional Notes (Optional)</label>
                    <textarea @bind="scheduleNotes" 
                              rows="3"
                              class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none transition"
                              placeholder="Any special instructions or requirements..."></textarea>
                </div>
            </div>
            <div class="flex gap-3">
                <button @onclick="HandleSchedule" 
                        disabled="@(isProcessing || !scheduledDateTime.HasValue)"
                        class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    @(isProcessing ? "Scheduling..." : "Schedule Appointment")
                </button>
                <button @onclick="CloseModals" 
                        disabled="@isProcessing"
                        class="flex-1 px-4 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

<!-- Equipment Assignment Modal -->
@if (showAssignEquipmentModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @onclick="CloseModals">
        <div class="bg-white rounded-xl p-5 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl" @onclick:stopPropagation="true">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Assign Equipment</h3>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Search Equipment</label>
								<input type="text" 
								value="@equipmentSearchTerm"
								@oninput="OnSearchInput"
								placeholder="Type equipment code, name, or category (min 2 chars)..."
								class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200 focus:outline-none transition" />

            </div>

            @if (isSearchingEquipment)
            {
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-orange-600 mb-3"></div>
                    <p class="text-sm text-gray-600 font-medium">Searching equipment...</p>
                </div>
            }
            else if (searchError != null)
            {
                <div class="p-4 bg-red-50 border-2 border-red-200 rounded-lg mb-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-red-800">Search Error</p>
                            <p class="text-sm text-red-700">@searchError</p>
                        </div>
                    </div>
                </div>
            }
            else if (availableEquipments.Any())
            {
                <div class="mb-4">
                    <p class="text-xs text-gray-600 font-medium mb-2">Found @availableEquipments.Count available equipment(s)</p>
                    <div class="border-2 border-gray-200 rounded-lg max-h-72 overflow-y-auto">
                        @foreach (var equipment in availableEquipments)
                        {
                            <div class="p-3 border-b last:border-b-0 hover:bg-gray-50 cursor-pointer transition @(selectedEquipmentId == equipment.Id ? "bg-orange-50 border-l-4 border-l-orange-600" : "")"
                                 @onclick="() => SelectEquipment(equipment)">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-bold text-gray-900">@equipment.Name</p>
                                        <p class="text-xs text-gray-600 mt-0.5">
                                            <span class="font-semibold">Code:</span> @equipment.EquipmentCode 
                                            <span class="mx-2">‚Ä¢</span> 
                                            <span class="font-semibold">Category:</span> @equipment.Category
                                        </p>
                                        @if (!string.IsNullOrWhiteSpace(equipment.Description))
                                        {
                                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">@equipment.Description</p>
                                        }
                                    </div>
                                    <span class="flex-shrink-0 text-xs px-2.5 py-1 rounded-full font-semibold @GetConditionBadge(equipment.Condition)">
                                        @equipment.Condition
                                    </span>
                                </div>
                                @if (selectedEquipmentId == equipment.Id)
                                {
                                    <div class="mt-2 flex items-center gap-2 text-xs text-orange-700 font-semibold">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                        Selected
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else if (!string.IsNullOrWhiteSpace(equipmentSearchTerm) && equipmentSearchTerm.Length >= 2)
            {
                <div class="text-center py-8">
                    <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <p class="text-sm text-gray-600 font-medium">No equipment found</p>
                    <p class="text-xs text-gray-500 mt-1">Try a different search term</p>
                </div>
            }
            else
            {
                <div class="text-center py-8">
                    <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <p class="text-sm text-gray-500 italic">Type at least 2 characters to search</p>
                </div>
            }

            @if (selectedEquipmentId > 0 && selectedEquipment != null)
            {
                <div class="p-4 bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-300 rounded-lg mb-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-orange-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-orange-800 uppercase tracking-wide mb-1">Selected Equipment</p>
                            <p class="text-sm font-bold text-orange-900">@selectedEquipment.Name</p>
                            <p class="text-xs text-orange-700">Code: @selectedEquipment.EquipmentCode | @selectedEquipment.Category</p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Expected Return Date (Optional)</label>
                    <input type="date" 
                           @bind="equipmentReturnDate"
                           min="@DateTime.Now.ToString("yyyy-MM-dd")"
                           class="w-full px-3 py-2.5 border-2 border-gray-300 rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200 focus:outline-none transition" />
                    <p class="text-xs text-gray-500 mt-1">Leave empty if return date is not specified</p>
                </div>
            }

            @if (assignmentError != null)
            {
                <div class="p-4 bg-red-50 border-2 border-red-200 rounded-lg mb-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm font-semibold text-red-800">Assignment Error</p>
                            <p class="text-sm text-red-700">@assignmentError</p>
                        </div>
                    </div>
                </div>
            }

            <div class="flex gap-3">
                <button @onclick="HandleAssignEquipment" 
                        disabled="@(isProcessing || selectedEquipmentId == 0)"
                        class="flex-1 px-4 py-2.5 bg-orange-600 text-white rounded-lg text-sm font-semibold hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-2">
                    @if (isProcessing)
                    {
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                        <span>Assigning...</span>
                    }
                    else if (selectedEquipmentId == 0)
                    {
                        <span>Select Equipment First</span>
                    }
                    else
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span>Assign Equipment</span>
                    }
                </button>
                <button @onclick="CloseModals" 
                        disabled="@isProcessing"
                        class="flex-1 px-4 py-2.5 border-2 border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 disabled:opacity-50 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public long ApplicationId { get; set; }

    // State
    private AdminApplicationDetailsDto? application;
    private bool isLoading = true;
    private bool isProcessing = false;

    // Modals
    private bool showApproveModal = false;
    private bool showRejectModal = false;
    private bool showScheduleModal = false;
    private bool showAssignEquipmentModal = false;
    private bool showDocumentModal = false;
    
    // Approve/Reject
    private long selectedSubmissionId = 0;
    private string rejectionReason = string.Empty;
    
    // Schedule
    private DateTime? scheduledDateTime = null;
    private string scheduleNotes = string.Empty;
    
    // Equipment Assignment
    private List<AvailableEquipmentDto> availableEquipments = new();
    private string equipmentSearchTerm = string.Empty;
    private bool isSearchingEquipment = false;
    private long selectedEquipmentId = 0;
    private AvailableEquipmentDto? selectedEquipment = null;
    private DateTime? equipmentReturnDate = null;
    private string? searchError = null;
    private string? assignmentError = null;
    private readonly Dictionary<long, string> assignmentActionNotes = new();
    private readonly HashSet<long> assignmentActionLoading = new();

    // Document Preview
    private AdminDocumentDto? selectedDocument = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadApplication();
    }

    private async Task LoadApplication()
    {
        isLoading = true;
        try
        {
            application = await Http.GetFromJsonAsync<AdminApplicationDetailsDto>($"api/admin/applications/{ApplicationId}");
        }
        catch
        {
            ToastService.ShowError("Failed to load application");
        }
        finally
        {
            isLoading = false;
        }
    }

    // Modal Controls
    private void ShowApproveModal(long submissionId)
    {
        selectedSubmissionId = submissionId;
        showApproveModal = true;
    }

    private void ShowRejectModal(long submissionId)
    {
        selectedSubmissionId = submissionId;
        rejectionReason = string.Empty;
        showRejectModal = true;
    }

    private void ShowScheduleModal()
    {
        scheduledDateTime = null;
        scheduleNotes = string.Empty;
        showScheduleModal = true;
    }

    private void ShowAssignEquipmentModal()
    {
        Console.WriteLine("üîß Opening equipment assignment modal");
        availableEquipments.Clear();
        equipmentSearchTerm = string.Empty;
        selectedEquipmentId = 0;
        selectedEquipment = null;
        equipmentReturnDate = null;
        searchError = null;
        assignmentError = null;
        showAssignEquipmentModal = true;
    }

    private void OpenDocumentModal(AdminDocumentDto document)
    {
        selectedDocument = document;
        showDocumentModal = true;
    }

    private void CloseDocumentModal()
    {
        showDocumentModal = false;
        selectedDocument = null;
    }

    private void CloseModals()
    {
        showApproveModal = false;
        showRejectModal = false;
        showScheduleModal = false;
        showAssignEquipmentModal = false;
        selectedSubmissionId = 0;
        rejectionReason = string.Empty;
        selectedEquipmentId = 0;
        selectedEquipment = null;
        searchError = null;
        assignmentError = null;
    }

    // Actions
    private async Task HandleApprove()
    {
        isProcessing = true;
        try
        {
            var response = await Http.PostAsync($"api/admin/applications/submissions/{selectedSubmissionId}/approve", null);
            
            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowSuccess("Submission approved successfully");
                CloseModals();
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to approve submission");
            }
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task HandleReject()
    {
        isProcessing = true;
        try
        {
            var request = new RejectSubmissionRequest { RejectionReason = rejectionReason };
            var response = await Http.PostAsJsonAsync($"api/admin/applications/submissions/{selectedSubmissionId}/reject", request);
            
            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowSuccess("Submission rejected");
                CloseModals();
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to reject submission");
            }
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task HandleSchedule()
    {
        if (!scheduledDateTime.HasValue) return;

        isProcessing = true;
        try
        {
            var request = new ScheduleAppointmentRequest { ScheduledDateTime = scheduledDateTime.Value, Notes = scheduleNotes };
            var response = await Http.PostAsJsonAsync($"api/admin/applications/{ApplicationId}/schedule", request);
            
            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowSuccess("Appointment scheduled successfully");
                CloseModals();
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to schedule appointment");
            }
        }
        finally
        {
            isProcessing = false;
        }
    }

    // Equipment Assignment
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        equipmentSearchTerm = e.Value?.ToString() ?? string.Empty;
        Console.WriteLine($"üîç Search input: '{equipmentSearchTerm}' (Length: {equipmentSearchTerm.Length})");
        await SearchEquipment();
    }

    private async Task SearchEquipment()
    {
        searchError = null;
        
        if (string.IsNullOrWhiteSpace(equipmentSearchTerm) || equipmentSearchTerm.Length < 2)
        {
            Console.WriteLine("‚ö†Ô∏è Search term too short, clearing results");
            availableEquipments.Clear();
            return;
        }

        isSearchingEquipment = true;
        Console.WriteLine($"üîé Searching for: '{equipmentSearchTerm}'");
        
        try
        {
            var url = $"api/Equipment/search?searchTerm={Uri.EscapeDataString(equipmentSearchTerm)}";
            Console.WriteLine($"üì° API URL: {url}");
            
            var result = await Http.GetFromJsonAsync<List<AvailableEquipmentDto>>(url);
            
            availableEquipments = result ?? new();
            Console.WriteLine($"‚úÖ Found {availableEquipments.Count} equipment(s)");
            
            if (availableEquipments.Any())
            {
                foreach (var eq in availableEquipments)
                {
                    Console.WriteLine($"  - {eq.Name} ({eq.EquipmentCode})");
                }
            }
        }
        catch (Exception ex)
        {
            searchError = $"Search failed: {ex.Message}";
            Console.WriteLine($"‚ùå Search error: {ex.Message}");
            availableEquipments.Clear();
        }
        finally
        {
            isSearchingEquipment = false;
        }
    }

    private void SelectEquipment(AvailableEquipmentDto equipment)
    {
        selectedEquipmentId = equipment.Id;
        selectedEquipment = equipment;
        Console.WriteLine($"‚úì Selected: {equipment.Name} (ID: {equipment.Id})");
    }

    private async Task HandleAssignEquipment()
    {
        if (selectedEquipmentId == 0 || selectedEquipment == null)
        {
            ToastService.ShowError("Please select equipment first");
            return;
        }

        assignmentError = null;
        isProcessing = true;
        Console.WriteLine($"üì§ Assigning equipment {selectedEquipmentId} to application {ApplicationId}");
        
        try
        {
            var request = new AssignEquipmentRequest
            {
                ApplicationId = ApplicationId,
                EquipmentId = selectedEquipmentId,
                ExpectedReturnDate = equipmentReturnDate
            };

            Console.WriteLine($"Request: AppId={request.ApplicationId}, EqId={request.EquipmentId}, Return={request.ExpectedReturnDate}");

            var response = await Http.PostAsJsonAsync("api/EquipmentAssignments", request);

            Console.WriteLine($"Response Status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚úÖ Success: {result}");
                
                ToastService.ShowSuccess($"Equipment '{selectedEquipment.Name}' assigned successfully!");
                CloseModals();
                await LoadApplication();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                assignmentError = $"Failed: {response.StatusCode} - {error}";
                Console.WriteLine($"‚ùå Assignment failed: {assignmentError}");
                ToastService.ShowError("Failed to assign equipment");
            }
        }
        catch (Exception ex)
        {
            assignmentError = $"Error: {ex.Message}";
            Console.WriteLine($"‚ùå Exception: {ex.Message}");
            ToastService.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private bool IsAssignmentActionLoading(long assignmentId) => assignmentActionLoading.Contains(assignmentId);

    private bool StartAssignmentAction(long assignmentId)
    {
        if (assignmentActionLoading.Contains(assignmentId))
            return false;

        assignmentActionLoading.Add(assignmentId);
        return true;
    }

    private void EndAssignmentAction(long assignmentId)
    {
        assignmentActionLoading.Remove(assignmentId);
    }

    private async Task ApproveReturnAsGood(long assignmentId)
    {
        if (!StartAssignmentAction(assignmentId)) return;

        try
        {
            var response = await Http.PostAsync($"api/EquipmentAssignments/{assignmentId}/approve-return", null);
            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowSuccess("Return approved as good");
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to approve return");
            }
        }
        finally
        {
            EndAssignmentAction(assignmentId);
        }
    }

    private async Task MarkAssignmentDamaged(long assignmentId)
    {
        assignmentActionNotes.TryGetValue(assignmentId, out var notes);
        if (string.IsNullOrWhiteSpace(notes))
        {
            ToastService.ShowError("Admin notes are required to mark damaged");
            return;
        }

        if (!StartAssignmentAction(assignmentId)) return;

        try
        {
            var response = await Http.PostAsJsonAsync(
                $"api/EquipmentAssignments/{assignmentId}/mark-damaged",
                new { AdminNotes = notes });

            if (response.IsSuccessStatusCode)
            {
                assignmentActionNotes[assignmentId] = string.Empty;
                ToastService.ShowSuccess("Equipment marked as damaged");
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to mark damaged");
            }
        }
        finally
        {
            EndAssignmentAction(assignmentId);
        }
    }

    private async Task RejectAssignmentReturn(long assignmentId)
    {
        assignmentActionNotes.TryGetValue(assignmentId, out var notes);
        if (string.IsNullOrWhiteSpace(notes))
        {
            ToastService.ShowError("Admin notes are required to reject return");
            return;
        }

        if (!StartAssignmentAction(assignmentId)) return;

        try
        {
            var response = await Http.PostAsJsonAsync(
                $"api/EquipmentAssignments/{assignmentId}/reject-return",
                new { AdminNotes = notes });

            if (response.IsSuccessStatusCode)
            {
                assignmentActionNotes[assignmentId] = string.Empty;
                ToastService.ShowSuccess("Return rejected");
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to reject return");
            }
        }
        finally
        {
            EndAssignmentAction(assignmentId);
        }
    }

    private async Task ResolveAssignment(long assignmentId, string finalStatus)
    {
        assignmentActionNotes.TryGetValue(assignmentId, out var notes);
        if (string.IsNullOrWhiteSpace(notes))
        {
            ToastService.ShowError("Admin notes are required to resolve dispute");
            return;
        }

        if (!StartAssignmentAction(assignmentId)) return;

        try
        {
            var response = await Http.PostAsJsonAsync(
                $"api/EquipmentAssignments/{assignmentId}/resolve",
                new { FinalStatus = finalStatus, Notes = notes });

            if (response.IsSuccessStatusCode)
            {
                assignmentActionNotes[assignmentId] = string.Empty;
                ToastService.ShowSuccess("Dispute resolved");
                await LoadApplication();
            }
            else
            {
                ToastService.ShowError("Failed to resolve dispute");
            }
        }
        finally
        {
            EndAssignmentAction(assignmentId);
        }
    }

    // Helpers
    private bool CanScheduleAppointment() => application != null && (application.Status == "InReview" || application.Status == "Submitted");
    private bool CanAssignEquipment() => application != null && (application.Status == "InReview" || application.Status == "Submitted");

    private string GetStatusBadge(string status) => status switch
    {
        "Draft" => "px-3 py-1.5 text-sm font-semibold rounded-full bg-gray-100 text-gray-700",
        "Submitted" => "px-3 py-1.5 text-sm font-semibold rounded-full bg-blue-100 text-blue-700",
        "InReview" => "px-3 py-1.5 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-700",
        "Approved" => "px-3 py-1.5 text-sm font-semibold rounded-full bg-green-100 text-green-700",
        "Rejected" => "px-3 py-1.5 text-sm font-semibold rounded-full bg-red-100 text-red-700",
        "Completed" => "px-3 py-1.5 text-sm font-semibold rounded-full bg-purple-100 text-purple-700",
        _ => "px-3 py-1.5 text-sm font-semibold rounded-full bg-gray-100 text-gray-700"
    };

    private string GetServiceTypeBadge(string type) => type switch
    {
        "EquipmentLoan" => "bg-orange-100 text-orange-700",
        "ChairmanAppointment" => "bg-indigo-100 text-indigo-700",
        _ => "bg-gray-100 text-gray-700"
    };

    private string GetSubmissionStatusBadge(string status) => status switch
    {
        "Pending" => "text-xs px-2.5 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold",
        "Approved" => "text-xs px-2.5 py-1 rounded-full bg-green-100 text-green-700 font-semibold",
        "Rejected" => "text-xs px-2.5 py-1 rounded-full bg-red-100 text-red-700 font-semibold",
        _ => "text-xs px-2.5 py-1 rounded-full bg-gray-100 text-gray-700 font-semibold"
    };

    private string GetConditionBadge(string condition) => condition switch
    {
        "Good" => "bg-green-100 text-green-700",
        "Fair" => "bg-yellow-100 text-yellow-700",
        _ => "bg-red-100 text-red-700"
    };

    private string GetStatusIcon(string status) => status switch
    {
        "Pending" => "‚è≥",
        "Approved" => "‚úÖ",
        "Rejected" => "‚ùå",
        _ => "‚Ä¢"
    };

    private string FormatServiceType(string type) => type switch
    {
        "ChairmanAppointment" => "Chairman Appointment",
        "EquipmentLoan" => "Equipment Loan",
        "GeneralApplication" => "General Application",
        _ => type
    };

    private bool IsImage(string fileName) => Path.GetExtension(fileName).ToLower() is ".jpg" or ".jpeg" or ".png" or ".gif" or ".webp" or ".bmp";
    private string GetFileExtension(string fileName) => Path.GetExtension(fileName).ToUpper().TrimStart('.');
    private string GetDocumentUrl(string filePath) => $"{Http.BaseAddress?.ToString().TrimEnd('/')}{filePath}";

    // DTOs
    public class ScheduleAppointmentRequest { public DateTime ScheduledDateTime { get; set; } public string? Notes { get; set; } }
    public class RejectSubmissionRequest { public string RejectionReason { get; set; } = string.Empty; }
    public class AssignEquipmentRequest { public long ApplicationId { get; set; } public long EquipmentId { get; set; } public DateTime? ExpectedReturnDate { get; set; } }
    public class AvailableEquipmentDto { public long Id { get; set; } public string Name { get; set; } = string.Empty; public string EquipmentCode { get; set; } = string.Empty; public string Category { get; set; } = string.Empty; public string Condition { get; set; } = string.Empty; public string? Description { get; set; } }
    public class AdminApplicationDetailsDto { public long Id { get; set; } public long ServiceId { get; set; } public string ServiceName { get; set; } = string.Empty; public string ServiceDescription { get; set; } = string.Empty; public string ServiceType { get; set; } = string.Empty; public long ApplicantId { get; set; } public string ApplicantName { get; set; } = string.Empty; public string ApplicantEmail { get; set; } = string.Empty; public string Status { get; set; } = string.Empty; public int CurrentStep { get; set; } public int TotalSteps { get; set; } public DateTime? ScheduledDateTime { get; set; } public DateTime? CompletedAt { get; set; } public string? AdminNotes { get; set; } public DateTime CreatedAt { get; set; } public List<AdminStepDetailDto> Steps { get; set; } = new(); public List<EquipmentAssignmentSummaryDto> EquipmentAssignments { get; set; } = new(); }
    public class AdminStepDetailDto { public long Id { get; set; } public string Name { get; set; } = string.Empty; public int Order { get; set; } public string? Instructions { get; set; } public bool RequiresFileUpload { get; set; } public bool RequiresTextInput { get; set; } public bool IsOptional { get; set; } public bool RequiresApproval { get; set; } public List<AdminStepSubmissionDto> Submissions { get; set; } = new(); }
    public class AdminStepSubmissionDto { public long Id { get; set; } public long StepId { get; set; } public int StepOrder { get; set; } public string StepName { get; set; } = string.Empty; public string? FormData { get; set; } public string Status { get; set; } = string.Empty; public DateTime SubmittedAt { get; set; } public DateTime? ReviewedAt { get; set; } public string? RejectionReason { get; set; } public bool IsLatest { get; set; } public List<AdminDocumentDto> Documents { get; set; } = new(); }
    public class AdminDocumentDto { public long Id { get; set; } public string FileName { get; set; } = string.Empty; public string FilePath { get; set; } = string.Empty; }
    public class EquipmentAssignmentSummaryDto { public long Id { get; set; } public long EquipmentId { get; set; } public string EquipmentName { get; set; } = string.Empty; public string EquipmentCode { get; set; } = string.Empty; public DateTime AssignedAt { get; set; } public DateTime? ExpectedReturnDate { get; set; } public string Status { get; set; } = string.Empty; }
}
