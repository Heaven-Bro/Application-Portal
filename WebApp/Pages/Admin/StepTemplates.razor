@page "/admin/services/create/step-templates"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Step Templates - Admin Panel</PageTitle>

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Step Templates</h1>
            <p class="text-sm text-gray-600 mt-1">Manage reusable workflow step templates</p>
        </div>
        <div class="flex items-center gap-3">
            <button @onclick="AddTemplate" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                + Create New Template
            </button>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="space-y-4">
            @foreach (var template in _templates)
            {
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">@template.Name</h3>
                            <p class="text-sm text-gray-600 mt-1">@template.Description</p>
                            <div class="flex gap-2 mt-2">
                                @if (template.RequiresFileUpload)
                                {
                                    <span class="inline-flex px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">File Upload</span>
                                }
                                @if (template.RequiresTextInput)
                                {
                                    <span class="inline-flex px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Text Input</span>
                                }
                                @if (template.IsEquipmentAssignment)
                                {
                                    <span class="inline-flex px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">Equipment</span>
                                }
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @onclick="() => EditTemplate(template)" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                            <button @onclick="() => DeleteTemplate(template)" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    @if (_showForm)
    {
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4">
                <h2 class="text-xl font-bold text-gray-900 mb-4">@(_editingTemplate == null ? "Create" : "Edit") Step Template</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Template Name *</label>
                        <input type="text" @bind="_formModel.Name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                               placeholder="e.g., Fill Application Form" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea @bind="_formModel.Description" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                  placeholder="Describe what this step does..."></textarea>
                    </div>

                    <div class="space-y-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" @bind="_formModel.RequiresFileUpload" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="text-sm text-gray-700">Requires File Upload</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" @bind="_formModel.RequiresTextInput" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="text-sm text-gray-700">Requires Text Input</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" @bind="_formModel.IsEquipmentAssignment" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded" />
                            <span class="text-sm text-gray-700">Equipment Assignment Step</span>
                        </label>
                    </div>
                </div>

                <div class="flex items-center justify-end space-x-4 mt-6 pt-4 border-t">
                    <button @onclick="CancelForm" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @onclick="SaveTemplate" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Save Template
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<StepTemplate> _templates = new()
    {
        new StepTemplate { Id = 1, Name = "Fill Application Form", Description = "Student fills basic application details", RequiresTextInput = true },
        new StepTemplate { Id = 2, Name = "Upload Documents", Description = "Upload required documents (ID, certificates)", RequiresFileUpload = true },
        new StepTemplate { Id = 3, Name = "Payment", Description = "Pay service fee", RequiresTextInput = true },
        new StepTemplate { Id = 4, Name = "Admin Review", Description = "Admin reviews the application", RequiresTextInput = false },
        new StepTemplate { Id = 5, Name = "Equipment Assignment", Description = "Assign equipment to student", IsEquipmentAssignment = true }
    };

    private bool _showForm = false;
    private StepTemplate? _editingTemplate = null;
    private StepTemplate _formModel = new();

    private void AddTemplate()
    {
        _editingTemplate = null;
        _formModel = new StepTemplate();
        _showForm = true;
    }

    private void EditTemplate(StepTemplate template)
    {
        _editingTemplate = template;
        _formModel = new StepTemplate
        {
            Id = template.Id,
            Name = template.Name,
            Description = template.Description,
            RequiresFileUpload = template.RequiresFileUpload,
            RequiresTextInput = template.RequiresTextInput,
            IsEquipmentAssignment = template.IsEquipmentAssignment
        };
        _showForm = true;
    }

    private void SaveTemplate()
    {
        if (_editingTemplate != null)
        {
            // Update existing
            _editingTemplate.Name = _formModel.Name;
            _editingTemplate.Description = _formModel.Description;
            _editingTemplate.RequiresFileUpload = _formModel.RequiresFileUpload;
            _editingTemplate.RequiresTextInput = _formModel.RequiresTextInput;
            _editingTemplate.IsEquipmentAssignment = _formModel.IsEquipmentAssignment;
        }
        else
        {
            // Add new
            _formModel.Id = _templates.Max(t => t.Id) + 1;
            _templates.Add(_formModel);
        }
        CancelForm();
    }

    private void DeleteTemplate(StepTemplate template)
    {
        _templates.Remove(template);
    }

    private void CancelForm()
    {
        _showForm = false;
        _editingTemplate = null;
    }

    public class StepTemplate
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool RequiresFileUpload { get; set; }
        public bool RequiresTextInput { get; set; }
        public bool IsEquipmentAssignment { get; set; }
    }
}
