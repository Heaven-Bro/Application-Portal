@page "/admin/services/create"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Create Service - Admin Panel</PageTitle>

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Create New Service</h1>
            <p class="text-sm text-gray-600 mt-1">Add a new service that students can apply for</p>
        </div>
        <a href="/admin/services" target="_blank" class="px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition text-sm font-medium inline-flex items-center">
            ← Back to Services
        </a>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <EditForm Model="@_serviceModel" OnValidSubmit="HandleSubmit" class="space-y-6">
            <DataAnnotationsValidator />
            
            <!-- Service Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Service Name -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Service Name <span class="text-red-500">*</span>
                    </label>
                    <InputText @bind-Value="_serviceModel.Name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="e.g., Transcript Request" />
                    <ValidationMessage For="@(() => _serviceModel.Name)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- Description -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Description <span class="text-red-500">*</span>
                    </label>
                    <InputTextArea @bind-Value="_serviceModel.Description" 
                                   rows="4"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Describe what this service is for..." />
                    <ValidationMessage For="@(() => _serviceModel.Description)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- Service Version -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Service Version <span class="text-red-500">*</span>
                    </label>
                    <InputNumber @bind-Value="_serviceModel.ServiceVersion" 
                                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                 placeholder="1" />
                    <ValidationMessage For="@(() => _serviceModel.ServiceVersion)" class="text-red-500 text-sm mt-1" />
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Status
                    </label>
                    <div class="flex items-center space-x-2">
                        <InputCheckbox @bind-Value="_serviceModel.IsActive" 
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
                        <span class="text-sm text-gray-700">Active (students can apply)</span>
                    </div>
                </div>
            </div>

            <!-- Service Steps Section -->
            <div class="border-t pt-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Service Steps</h2>
                        <p class="text-sm text-gray-600">Select step templates to build the workflow</p>
                    </div>
                    <a href="/admin/step-templates" target="_blank" class="px-4 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition text-sm font-medium inline-flex items-center">
    Manage Templates →
</a>

                </div>

                <!-- Available Templates -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Available Step Templates</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        @foreach (var template in _availableTemplates)
                        {
                            <button type="button" @onclick="() => AddStepFromTemplate(template)"
                                    class="text-left p-3 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 transition">
                                <div class="font-medium text-gray-900">@template.Name</div>
                                <div class="text-xs text-gray-600 mt-1">@template.Description</div>
                            </button>
                        }
                    </div>
                </div>

                <!-- Selected Steps -->
                @if (_serviceModel.Steps.Count == 0)
                {
                    <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <p class="text-gray-500">No steps added. Click a template above to add it to the workflow.</p>
                    </div>
                }
                else
                {
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">Selected Steps (in order)</label>
                        @foreach (var step in _serviceModel.Steps.OrderBy(s => s.Order))
                        {
                            <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg p-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-semibold">
                                    @step.Order
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">@step.Name</div>
                                    <div class="text-sm text-gray-600">@step.Description</div>
                                </div>
                                <button type="button" @onclick="() => MoveStepUp(step)" 
                                        disabled="@(step.Order == 1)"
                                        class="px-2 py-1 text-sm text-gray-600 hover:text-gray-900 disabled:opacity-30">
                                    ↑
                                </button>
                                <button type="button" @onclick="() => MoveStepDown(step)"
                                        disabled="@(step.Order == _serviceModel.Steps.Count)"
                                        class="px-2 py-1 text-sm text-gray-600 hover:text-gray-900 disabled:opacity-30">
                                    ↓
                                </button>
                                <button type="button" @onclick="() => RemoveStep(step)"
                                        class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                                    Remove
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-4 pt-6 border-t">
                <a href="/admin/services" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    Create Service
                </button>
            </div>
        </EditForm>

        @if (!string.IsNullOrEmpty(_message))
        {
            <div class="mt-4 p-4 rounded-lg @(_isSuccess ? "bg-green-50 text-green-800" : "bg-red-50 text-red-800")">
                @_message
            </div>
        }
    </div>
</div>

@code {
    private ServiceFormModel _serviceModel = new();
    private string _message = string.Empty;
    private bool _isSuccess = false;

    private List<StepTemplate> _availableTemplates = new()
    {
        new StepTemplate 
        { 
            Name = "Fill Application Form", 
            Description = "Student fills basic application details", 
            RequiresTextInput = true 
        },
        new StepTemplate 
        { 
            Name = "Upload Documents", 
            Description = "Upload required documents (ID, certificates)", 
            RequiresFileUpload = true 
        },
        new StepTemplate 
        { 
            Name = "Payment", 
            Description = "Pay service fee", 
            RequiresTextInput = true 
        },
        new StepTemplate 
        { 
            Name = "Admin Review", 
            Description = "Admin reviews and approves the application" 
        },
        new StepTemplate 
        { 
            Name = "Equipment Assignment", 
            Description = "Assign equipment to student", 
            IsEquipmentAssignment = true 
        },
        new StepTemplate 
        { 
            Name = "Schedule Appointment", 
            Description = "Schedule date and time for service", 
            RequiresTextInput = true 
        }
    };

    private void AddStepFromTemplate(StepTemplate template)
    {
        var nextOrder = _serviceModel.Steps.Count > 0 ? _serviceModel.Steps.Max(s => s.Order) + 1 : 1;
        
        _serviceModel.Steps.Add(new ServiceStepModel
        {
            Order = nextOrder,
            Name = template.Name,
            Description = template.Description,
            RequiresFileUpload = template.RequiresFileUpload,
            RequiresTextInput = template.RequiresTextInput,
            IsEquipmentAssignment = template.IsEquipmentAssignment
        });
    }

    private void MoveStepUp(ServiceStepModel step)
    {
        if (step.Order == 1) return;
        var otherStep = _serviceModel.Steps.First(s => s.Order == step.Order - 1);
        otherStep.Order++;
        step.Order--;
    }

    private void MoveStepDown(ServiceStepModel step)
    {
        if (step.Order == _serviceModel.Steps.Count) return;
        var otherStep = _serviceModel.Steps.First(s => s.Order == step.Order + 1);
        otherStep.Order--;
        step.Order++;
    }

    private void RemoveStep(ServiceStepModel step)
    {
        _serviceModel.Steps.Remove(step);
        // Reorder remaining steps
        var orderedSteps = _serviceModel.Steps.OrderBy(s => s.Order).ToList();
        for (int i = 0; i < orderedSteps.Count; i++)
        {
            orderedSteps[i].Order = i + 1;
        }
    }

    private void HandleSubmit()
    {
        // TODO: Save to database (service + steps)
        _isSuccess = true;
        _message = $"Service '{_serviceModel.Name}' created successfully with {_serviceModel.Steps.Count} step(s)!";
        
        // Reset form
        _serviceModel = new ServiceFormModel { ServiceVersion = 1, IsActive = true };
    }

    public class ServiceFormModel
    {
        [Required(ErrorMessage = "Service name is required")]
        [StringLength(255, ErrorMessage = "Service name cannot exceed 255 characters")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Description is required")]
        [StringLength(1000, ErrorMessage = "Description cannot exceed 1000 characters")]
        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Service version is required")]
        [Range(1, 100, ErrorMessage = "Version must be between 1 and 100")]
        public int ServiceVersion { get; set; } = 1;

        public bool IsActive { get; set; } = true;

        public List<ServiceStepModel> Steps { get; set; } = new();
    }

    public class ServiceStepModel
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int Order { get; set; }
        public bool RequiresFileUpload { get; set; }
        public bool RequiresTextInput { get; set; }
        public bool IsEquipmentAssignment { get; set; }
    }

    public class StepTemplate
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool RequiresFileUpload { get; set; }
        public bool RequiresTextInput { get; set; }
        public bool IsEquipmentAssignment { get; set; }
    }
}
