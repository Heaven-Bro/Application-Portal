@page "/admin/services/create"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IToastService ToastService

<PageTitle>Create Service - Admin Panel</PageTitle>

<div class="max-w-5xl mx-auto p-4 md:p-6">
    <div class="flex items-center justify-between mb-6">
        <div>
            <button class="flex items-center gap-2 px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors mb-3" @onclick="NavigateBack">
                <span>←</span>
                <span>Back to Services</span>
            </button>
            <h1 class="text-3xl font-bold font-title text-gray-900">Create New Service</h1>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <EditForm Model="model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="space-y-6 pb-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold font-title text-gray-900">Basic Information</h3>
                
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1.5">Service Name *</label>
                    <InputText id="name" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                              @bind-Value="model.Name" 
                              placeholder="e.g., Chairman Appointment Request" />
                    <ValidationMessage For="@(() => model.Name)" class="text-xs text-red-600 mt-1" />
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1.5">Description *</label>
                    <InputTextArea id="description" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow resize-none" 
                                  @bind-Value="model.Description" 
                                  rows="3"
                                  placeholder="Describe what this service is for..." />
                    <ValidationMessage For="@(() => model.Description)" class="text-xs text-red-600 mt-1" />
                </div>

                <div>
                    <label for="serviceType" class="block text-sm font-medium text-gray-700 mb-1.5">Service Type *</label>
                    <InputSelect id="serviceType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" @bind-Value="model.ServiceType">
                        <option value="">-- Select Service Type --</option>
                        <option value="0">Chairman Appointment</option>
                        <option value="1">Equipment Loan</option>
                        <option value="2">General Application</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => model.ServiceType)" class="text-xs text-red-600 mt-1" />
                </div>
            </div>

            <div class="space-y-6 pt-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold font-title text-gray-900">Service Steps</h3>
                    <button type="button" class="flex items-center gap-1.5 px-3 py-1.5 bg-surface text-sm font-medium rounded-lg hover:opacity-90 transition-opacity" @onclick="AddStep">
                        <span>+</span> Add Step
                    </button>
                </div>

                @if (!model.Steps.Any())
                {
                    <div class="text-center py-8 bg-gray-50 rounded-lg">
                        <p class="text-gray-500 text-sm">No steps added yet. Click "Add Step" to create workflow steps.</p>
                    </div>
                }
                else
                {
                    <div class="space-y-4">
                        @foreach (var (step, index) in model.Steps.Select((s, i) => (s, i)))
                        {
                            <div class="bg-gray-50 rounded-lg p-4 border-2 border-transparent hover:border-primary transition-colors">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm font-semibold text-primary font-title">Step @(index + 1)</span>
                                        <label class="flex items-center gap-1.5 text-xs text-gray-600 cursor-pointer select-none">
                                            <InputCheckbox class="w-3.5 h-3.5 rounded border-gray-300" @bind-Value="step.IsOptional" />
                                            <span>Optional</span>
                                        </label>
                                    </div>
                                    <button type="button" class="px-2 py-1 bg-red-500 text-xs rounded hover:bg-red-600 transition-colors" @onclick="() => RemoveStep(index)">
                                        Remove
                                    </button>
                                </div>

                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Step Name *</label>
                                        <InputText class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                  @bind-Value="step.Name" 
                                                  placeholder="e.g., Upload Application Form" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Instructions</label>
                                        <InputTextArea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow resize-none" 
                                                      @bind-Value="step.Instructions" 
                                                      rows="2"
                                                      placeholder="Provide clear instructions for this step..." />
                                        <p class="text-xs text-gray-500 mt-1">This will be shown to students for guidance</p>
                                    </div>

                                    <div class="pt-2 border-t border-gray-200">
                                        <p class="text-xs font-medium text-gray-700 mb-2">Downloadable Form (Optional)</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <InputText class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                          @bind-Value="step.DownloadableFormUrl" 
                                                          placeholder="Form URL" />
                                            </div>
                                            <div>
                                                <InputText class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                          @bind-Value="step.DownloadableFormLabel" 
                                                          placeholder="Link text (e.g., Download Form)" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pt-2 border-t border-gray-200">
                                        <div class="flex items-center gap-2 mb-2">
                                            <InputCheckbox id="@($"fileUpload_{index}")" 
                                                          class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-primary cursor-pointer" 
                                                          @bind-Value="step.RequiresFileUpload" />
                                            <label for="@($"fileUpload_{index}")" class="text-sm font-medium text-gray-700 cursor-pointer select-none">
                                                Requires File Upload
                                            </label>
                                        </div>

                                        @if (step.RequiresFileUpload)
                                        {
                                            <div class="ml-6 space-y-2 mt-2">
                                                <InputText class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                          @bind-Value="step.FileUploadLabel" 
                                                          placeholder="Upload label (e.g., Upload Application)" />
                                                <InputText class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                          @bind-Value="step.FileUploadInstructions" 
                                                          placeholder="Upload instructions" />
                                                <div class="grid grid-cols-2 gap-2">
                                                    <InputText class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                              @bind-Value="step.AllowedFileTypes" 
                                                              placeholder="pdf,jpg,png" />
                                                    <InputNumber class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-shadow" 
                                                                @bind-Value="step.MaxFilesCount" 
                                                                placeholder="Max files" />
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <InputCheckbox id="@($"textInput_{index}")" 
                                                      class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-primary cursor-pointer" 
                                                      @bind-Value="step.RequiresTextInput" />
                                        <label for="@($"textInput_{index}")" class="text-sm font-medium text-gray-700 cursor-pointer select-none">
                                            Requires Text Input
                                        </label>
                                    </div>

                                    <div class="flex items-center gap-2">
                                        <InputCheckbox id="@($"requiresApproval_{index}")"
                                                      class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-primary cursor-pointer"
                                                      @bind-Value="step.RequiresApproval" />
                                        <label for="@($"requiresApproval_{index}")" class="text-sm font-medium text-gray-700 cursor-pointer select-none">
                                            Requires Admin Approval
                                        </label>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            @if (errorMessage != null)
            {
                <div class="flex items-start gap-3 p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg mt-4 text-sm">
                    <span class="text-lg">⚠</span>
                    <div class="flex-1">
                        <p class="font-medium mb-1">Failed to create service</p>
                        <p class="text-xs">@errorMessage</p>
                    </div>
                    <button type="button" class="text-red-600 hover:text-red-800" @onclick="() => errorMessage = null">✕</button>
                </div>
            }

            <div class="flex justify-end gap-3 pt-6 mt-6 border-t border-gray-200">
                <button type="button" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors" @onclick="NavigateBack">
                    Cancel
                </button>
                <SubmitButton 
                    ButtonText="Create Service"
                    ProcessingText="Creating..."
                    IsProcessing="@isSubmitting"
                    IsDisabled="@(!model.Steps.Any())"
                    OnClick="HandleSubmit" />
            </div>
        </EditForm>
    </div>
</div>

@code {
    private CreateServiceModel model = new();
    private bool isSubmitting = false;
    private string? errorMessage;

    private void AddStep()
    {
        model.Steps.Add(new CreateServiceStepModel
        {
            Order = model.Steps.Count + 1
        });
    }

    private void RemoveStep(int index)
    {
        model.Steps.RemoveAt(index);
        for (int i = 0; i < model.Steps.Count; i++)
        {
            model.Steps[i].Order = i + 1;
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;

            var response = await Http.PostAsJsonAsync("api/services", new
            {
                Name = model.Name,
                Description = model.Description,
                ServiceType = int.Parse(model.ServiceType),
                Steps = model.Steps.Select(s => new
                {
                    s.Name,
                    s.Order,
                    s.RequiresFileUpload,
                    s.RequiresTextInput,
                    s.RequiresApproval,
                    s.Instructions,
                    s.DownloadableFormUrl,
                    s.IsOptional,
                    UploadConfig = s.RequiresFileUpload ? System.Text.Json.JsonSerializer.Serialize(new
                    {
                        Label = s.FileUploadLabel,
                        Instructions = s.FileUploadInstructions,
                        AllowedTypes = s.AllowedFileTypes?.Split(',').Select(t => t.Trim()).ToArray(),
                        MaxFiles = s.MaxFilesCount
                    }) : null
                }).ToList()
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CreateServiceResponse>();
                
                if (result?.ServiceId > 0)
                {
                    ToastService.ShowSuccess($"Service '{model.Name}' created successfully!");
                    await Task.Delay(800);
                    Navigation.NavigateTo("/admin/services");
                }
                else
                {
                    errorMessage = "Service created but ID was not returned. Check the database.";
                    ToastService.ShowWarning("Service may not have been saved properly");
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Server returned {(int)response.StatusCode}: {errorContent}";
                ToastService.ShowError("Failed to create service");
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Network error: {ex.Message}";
            ToastService.ShowError($"Network error: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
            ToastService.ShowError($"Unexpected error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void NavigateBack() => Navigation.NavigateTo("/admin/services");

    public class CreateServiceModel
    {
        [Required(ErrorMessage = "Service name is required")]
        [StringLength(255)]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Description is required")]
        [StringLength(1000)]
        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Service type is required")]
        public string ServiceType { get; set; } = string.Empty;

        public List<CreateServiceStepModel> Steps { get; set; } = new();
    }

    public class CreateServiceStepModel
    {
        public string Name { get; set; } = string.Empty;
        public int Order { get; set; }
        public bool IsOptional { get; set; }
        public bool RequiresFileUpload { get; set; }
        public bool RequiresTextInput { get; set; }
        public bool RequiresApproval { get; set; } = true;
        public string? Instructions { get; set; }
        public string? DownloadableFormUrl { get; set; }
        public string? DownloadableFormLabel { get; set; }
        public string? FileUploadLabel { get; set; }
        public string? FileUploadInstructions { get; set; }
        public string? AllowedFileTypes { get; set; }
        public int? MaxFilesCount { get; set; }
    }

    public class CreateServiceResponse
    {
        public long ServiceId { get; set; }
    }
}
